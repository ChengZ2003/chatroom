<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            display: flex; /* Make the layout flexible for sidebar */
        }
        .container {
            max-width: 85%;
            margin: auto;
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.1);
            flex: 1; /* Allow container to fill space */
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
        }
        .input-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .input-section textarea {
            width: 60%;
            padding: 10px;
            resize: none;
        }
        .input-section button {
            width: 15%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .input-section button:hover {
            background-color: #218838;
        }
        /* Sidebar style */
        .sidebar {
            width: 200px;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.1);
            margin-right: 20px;
        }
        .sidebar h3 {
            margin-top: 0;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            padding: 5px 0;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>åœ¨çº¿ç”¨æˆ·</h3>
        <ul id="user-list">
            <!-- ç”¨æˆ·åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </ul>
    </div>
    <div class="container">
        <div class="header">
            <h1>ç‹è€…èŠå¤©å®¤â€”â€”â€”<span id="room-name"></span>æˆ¿é—´</h1>
            <p>æ¬¢è¿å›æ¥: <span id="username"></span></p>
            <p style="display: none;">æ—¶é—´: <span id="time"></span></p>
        </div>
        <div class="messages" id="chat-messages">
            <!-- èŠå¤©è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <div class="input-section">
            <textarea id="message-input" rows="3" placeholder="è¯·è¾“å…¥èŠå¤©å†…å®¹"></textarea>
            <button id="send-button">å‘é€æ¶ˆæ¯</button>
            <div id="color-picker">
                <span class="color-label">å®šä¹‰èŠå¤©æ–‡å­—çš„é¢œè‰²ï¼š</span> <!-- æ·»åŠ æç¤ºæ–‡æœ¬ -->
                <input type="color" id="color-input">
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        // ä» URL ä¸­è·å–ç”¨æˆ·åå’Œæˆ¿é—´ä¿¡æ¯
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        const room = urlParams.get('room');

        document.getElementById('username').textContent = username;
        document.getElementById('time').textContent = formatDateTime(new Date());
        document.getElementById('room-name').textContent = room;

        // åˆ›å»º Socket è¿æ¥
        const socket = io(`http://localhost:3000`);

        // åˆå§‹åŒ–èŠå¤©è®°å½•åŒºåŸŸ
        const chatMessages = document.getElementById('chat-messages');
        const userList = document.getElementById('user-list');

        let hasLoadedMessages = false;

        // åŠ å…¥èŠå¤©å®¤å¹¶è¯·æ±‚å†å²æ¶ˆæ¯å’Œç”¨æˆ·åˆ—è¡¨
        socket.emit('joinRoom', { username, room });

        // ç›‘å¬å†å²æ¶ˆæ¯åŠ è½½
        socket.on('loadMessages', (messages) => {
            messages.forEach(msg => {
                const messageTime = formatDateTime(new Date(msg.timestamp)); // ä½¿ç”¨å†å²æ¶ˆæ¯çš„ timestamp å­—æ®µ
                appendMessage(msg.username, msg.message, msg.color, messageTime);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
            hasLoadedMessages = true; // æ ‡è®°å†å²æ¶ˆæ¯åŠ è½½å®Œæˆ
        });

        // ç›‘å¬æ–°æ¶ˆæ¯
        socket.on('receiveMessage', ({ username, message, color }) => {
            const messageTime = formatDateTime(new Date()); // è·å–å½“å‰æ—¶é—´
            appendMessage(username, message, color, messageTime);
            chatMessages.scrollTop = chatMessages.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        });

        // ç›‘å¬æ–°ç”¨æˆ·åŠ å…¥æ¶ˆæ¯ï¼ˆå»¶è¿Ÿå‘é€ï¼Œç¡®ä¿å†å²æ¶ˆæ¯åŠ è½½å®Œåå†å¤„ç†ï¼‰
        socket.on('newUserJoin', ({ username }) => {
            if (hasLoadedMessages) {
                const systemMessage = `${formatDateTime(new Date())} æœåŠ¡å™¨ è¯´ï¼š${username} åŠ å…¥äº†èŠå¤©å®¤ã€‚ğŸ˜Š`;
                appendSystemMessage(systemMessage);
                scrollToBottom();
            }
        });

        // ç›‘å¬æ¬¢è¿æ¶ˆæ¯ï¼ˆåªå‘é€ç»™æ–°ç”¨æˆ·ï¼‰
        socket.on('welcome', ({ username }) => {
            if (hasLoadedMessages) {
                const welcomeMessage = `${formatDateTime(new Date())} æœåŠ¡å™¨ è¯´ï¼šæ¬¢è¿ ${username} åŠ å…¥èŠå¤©å®¤ï¼ğŸ˜Š`;
                appendSystemMessage(welcomeMessage);
                scrollToBottom();
            }
        });

        // ç›‘å¬åœ¨çº¿ç”¨æˆ·æ›´æ–°
        socket.on('updateUserList', (users) => {
            userList.innerHTML = ''; // æ¸…ç©ºå½“å‰ç”¨æˆ·åˆ—è¡¨
            users.forEach(user => {
                const userElement = document.createElement('li');
                userElement.textContent = user;
                userList.appendChild(userElement);
            });
        });

        // ç›‘å¬ç”¨æˆ·ç¦»å¼€æˆ¿é—´çš„ç³»ç»Ÿæ¶ˆæ¯
        socket.on('userLeft', ({ username, room }) => {
            const systemMessage = `${formatDateTime(new Date())} æœåŠ¡å™¨ è¯´ï¼š${username} å·²ç»ç¦»å¼€èŠå¤©å®¤ã€‚ğŸ˜Š`;
            appendSystemMessage(systemMessage);
            scrollToBottom();
        });

        // å‘é€æ¶ˆæ¯
        document.getElementById('send-button').addEventListener('click', function() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            if (messageText !== '') {
                const color = document.getElementById('color-input').value || '#000';
                socket.emit('sendMessage', { username, message: messageText, color, room });
                messageInput.value = '';
            }
        });

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºæ¶ˆæ¯å…ƒç´ å¹¶æ˜¾ç¤º
        function appendMessage(username, message, color, time) {
            const messageElement = document.createElement('p');
            messageElement.style.color = color || '#000';
            messageElement.innerHTML = `${time} ${username} è¯´ï¼š${message}`;
            chatMessages.appendChild(messageElement);
        }

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºç³»ç»Ÿæ¶ˆæ¯å…ƒç´ å¹¶æ˜¾ç¤º
        function appendSystemMessage(message) {
            const messageElement = document.createElement('p');
            messageElement.style.color = 'blue'; // ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤ºä¸ºè“è‰²
            messageElement.innerHTML = message;
            chatMessages.appendChild(messageElement);
        }

        // æ»šåŠ¨åˆ°æ¶ˆæ¯æ¡†çš„åº•éƒ¨
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(date) {
            // è·å–å¹´ã€æœˆã€æ—¥
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // æœˆä»½ä»0å¼€å§‹ï¼Œéœ€è¦åŠ 1ï¼Œå¹¶ç¡®ä¿ä¸¤ä½æ•°
            const day = String(date.getDate()).padStart(2, '0'); // ç¡®ä¿ä¸¤ä½æ•°

            // è·å–æ—¶ã€åˆ†ã€ç§’
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            // ç»„åˆæˆæ‰€éœ€çš„æ ¼å¼ YYYY-MM-DD HH:MM:SS
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>
